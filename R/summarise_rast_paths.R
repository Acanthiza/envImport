

#' Summarise raster files
#'
#' Rasters are stacked via [terra::rast()], then summaries are generated by
#' [terra::app()]. Summaries are saved to file. Rasters are split
#' by index (using [terra::subset()]) before summarising, allowing for
#' multi-layer rasters. Lyr`n` is added to filename.
#'
#' @param paths Character. Paths to any raster that can be read by
#' [terra::rast()].
#' @param product,season,epoch Character. Descriptors for rasters being
#' summarised. See [envEcosystems::env].
#' @param out_dir Character. Path for saving summarised rasters.
#' @param force_new Logical. Run summarise even if resulting file already
#' exists.
#' @param funcs Function to apply to each vector of stacked cells.
#' @param out_type Extension for raster file written. Required as filename is
#' created from `out_base` and `func` so can't be passed directly.
#' @param ... Passed to [terra::app()]. Thus, (presumably) includes options to
#' [terra::writeRaster()] via `wopt` argument (untested).
#'
#' @return Side effect of saving summarised raster(s) to file.
#' @export
#'
#' @examples
#'
#'
summarise_rast_paths <- function(paths
                                 , product
                                 , season = NA
                                 , epoch = NA
                                 , out_dir
                                 , force_new = FALSE
                                 , funcs = c("mean", "median", "min", "max", "sd")
                                 , out_type = "tif"
                                 , exclude_layers = NULL
                                 , ...
                                 ) {

  s <- terra::rast(as.character(paths))

  all_layers <- names(terra::rast(paths[[1]]))

  if(isTRUE(!is.null(exclude_layers))) {

    if(is.numeric(exclude_layers)) layers <- layers[-exclude_layers]

    if(is.character(exclude_layers)) layers <- layers[!layers %in% exclude_layers]

  } else layers <- all_layers

  stacks <- tibble::tibble(layer = all_layers) %>%
    dplyr::mutate(layer_id = dplyr::row_number()
                  , subsets = purrr::map(layer_id
                                         , ~ seq(.
                                                 , length(layers)* length(paths)
                                                 , by = length(layers)
                                                 )
                                         )
                  ) %>%
    dplyr::filter(layer %in% layers) %>%
    dplyr::mutate(s = purrr::map(subsets
                                   , ~terra::subset(s
                                                    , .
                                                    )
                                   )
                  ) %>%
    dplyr::left_join(tibble::tibble(func = funcs)
                     , by = character()
                     ) %>%
    dplyr::mutate(out_file = fs::path(out_dir
                                      , paste0(product
                                               , "_lyr"
                                               , layer_id
                                               , "_"
                                               , func
                                               , "_"
                                               , season
                                               , "_"
                                               , epoch
                                               , "."
                                               , out_type
                                               )
                                      )
                  )

  summarise_func <- function(lyr_stack
                             , func_name
                             , out_file
                             ) {

    do <- !file.exists(out_file)

    if(force_new) do <- TRUE

    if(do) {

      terra::app(lyr_stack
                 , fun = get(func_name)
                 , filename = out_file
                 , ...
                 )

    }

  }

  purrr::pwalk(list(stacks$s
                    , stacks$func
                    , stacks$out_file
                    )
               , summarise_func
               )

}

